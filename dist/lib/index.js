#!/usr/bin/env node
"use strict";let e={react:{mini:"mini-template",pc:"pc-template",h5:"h5-template"},weapp:{js:"weapp-template",ts:"weapp-template-ts"},vue:{}};function t(e,t,n,r){return new(n||(n=Promise))((function(s,c){function o(e){try{a(r.next(e))}catch(e){c(e)}}function i(e){try{a(r.throw(e))}catch(e){c(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,i)}a((r=r.apply(e,t||[])).next())}))}const n=require("fs");const r=require("fs");function s(e,r){return t(this,void 0,void 0,(function*(){if("weapp"===e.lang)return yield function(e,t){return new Promise(((r,s)=>{try{let s=process.cwd()+`/${e.projectName}/project.config.json`;const c=JSON.parse(n.readFileSync(s).toString("utf-8"));n.rename(process.cwd()+`/${e.projectName}/miniprogram/app.wxss`,process.cwd()+`/${e.projectName}/miniprogram/app.${t[0]}`,(()=>{})),t.forEach((e=>{c.setting.useCompilerPlugins.push(e)})),n.writeFileSync(s,Buffer.from(JSON.stringify(c,null,2),"utf-8")),r("success")}catch(e){s(e)}}))}(e,r)}))}function c(e){let t=[];r.existsSync(e)&&(t=r.readdirSync(e),t.forEach(((t,n)=>{let s=e+"/"+t;r.statSync(s).isDirectory()?c(s):r.unlinkSync(s)})),r.rmdirSync(e))}const o=require("single-line-log").stdout,i=require("chalk");class a{constructor(e={}){this.initConfig(e)}initConfig(e){const t={duration:100,current:0,block:"█",showNumber:!0,tip:{0:"努力构建中🔧……",50:"加载一半啦，不要着急🐶……",75:"马上就加载完了😊……",100:"创建完成😄"},color:"blue"};Object.assign(t,e),this.config=t}run(e){const{block:t,duration:n,tip:r,color:s,showNumber:c}=this.config;let a=Object.keys(r).sort(((e,t)=>parseInt(t)-parseInt(e))),p=r[0];const l=n/100,u=Math.floor(e/l);for(let e=0;e<a.length;e++)if(u>=parseInt(a[e])){p=r[a[e]];break}o(i[s](t.repeat(Math.floor(u/2)),(c?u+"% ":"")+p)),100==u&&console.log("")}}const p=require("chalk"),l=require("inquirer"),{exec:u}=require("child_process"),m=require("fs");function g(t){m.existsSync(t.projectName)&&(console.log(p.red(`file ${t.projectName} already exist！！！`)),process.exit());let n=t.type.split("+");t.type=n.shift();let r,o=n,i=0,l=new a;var g,f;r=setInterval((()=>{l.run(i++),50==i&&clearInterval(r)}),100),u(`git clone ${g=t.lang,f=t.type,`https://gitee.com/wukongyang/${e[g][f]}.git`} ${t.projectName}`,((e,n,i)=>{e&&(console.log(e),process.exit()),l.run(75),s(t,o).then((()=>{l.run(100),console.log(p.green("Create Project Success!!!")),console.log(p.green(`cd ${t.projectName}`)),console.log(p.green("npm install")),process.exit()})).catch((()=>{clearInterval(r),console.log(p.red(`create ${t.projectName} fail!!!`)),c(process.cwd()+`/${t.projectName}`)}))}))}const f={params:"[project-name]",description:"create a new project",action:e=>{let t=g;e?t(e):l.prompt([{type:"input",message:"项目名称:",name:"projectName",validate:e=>e&&e.trim()?!e.includes(" ")||p.red("项目名不能包含空格，请重新输入"):p.red("项目名不能为空，请重新输入")},{type:"list",message:"请选择你需要创建的模版",name:"lang",choices:["react","vue","weapp"]},{type:"list",message:"请选择你需要创建的模版",name:"type",when:e=>"weapp"===e.lang,choices:["ts","ts+less","ts+scss","js","js+less","js+scss"]},{type:"list",when:e=>"Vue"===e.lang,message:"请选择你需要创建的项目类型",name:"type",choices:["Vue-ssr","Vue-h5"]},{type:"list",when:e=>"React"===e.lang,message:"请选择你需要创建的项目类型",name:"type",choices:["pc","mini","h5"]}]).then((e=>{t(e)}))}},h=require("chalk");let d={create:f,version:{params:"[package-version]",description:"package version",action:()=>{console.log(h.green("1.0.1"))}}};const{Command:y}=require("commander"),w=new y;Reflect.ownKeys(d).map((e=>{const{params:t,action:n,description:r}=d[e]||{};w.command(`${e} ${t||""}`).description(r).action((e=>{"function"==typeof n&&n(e)}))})),w.parse(process.argv);
